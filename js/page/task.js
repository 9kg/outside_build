$(function(){function t(t,e){$.ajax({url:urls.change_status,dataType:"json",type:"POST",data:{task_status:t,task_id:e,token:token}}).done(function(t){console.dir(t),i.data=null,i.render()}).fail(function(t){console.dir(t)})}function e(){d.show();var t={$ct:$(".sel_task"),sendData:{token:localStorage.getItem("token")},col:[{key:"id",width:20,render:function(t,e){var a=$('<label class="radio"><input type="radio" value="'+e+'" name="radio_task"><span class="opt_imitate"></span></label>');t.append(a)}},{key:"id",title:"ID",sort:!0,filter:!0},{key:"name",title:"名称",sort:!1,filter:!0},{key:"countall",title:"数量",sort:!0,filter:!0}],isLocal:!0,theme:"lightblue",url:urls.dialog_task},e={$ct:$(".sel_channel"),sendData:{token:localStorage.getItem("token")},col:[{key:"id",width:20,render:function(t,e){var a=$('<label class="radio"><input type="radio" value="'+e+'" name="radio_channel"><span class="opt_imitate"></span></label>');t.append(a)}},{key:"id",title:"ID",sort:!0,filter:!0},{key:"name",title:"名称",sort:!1,filter:!0}],isLocal:!0,theme:"warning",url:urls.dialog_channel};r?(o.render(),s.render()):(o=new Table(t),s=new Table(e),r=!0)}function a(t,e){$.ajax({url:urls.import_task,dataType:"json",type:"POST",data:{o_task_id:t,affiliate_id:e,token:localStorage.getItem("token")}}).done(function(e){1===e.status&&($.each(o.data,function(e,a){return a.id===t?(o.data.splice(e,1),!1):void 0}),o.render(),i.render())}).fail(function(t){console.dir(t)})}function n(t){$(".btn_pause").toggleClass("hidden",1!==t),$(".btn_stop").toggleClass("hidden",-1!==t&&1!==t),$(".btn_start").toggleClass("hidden",-1!==t),i.sendData.task_status=t,i.sendData.cur_page=1,i.theme=l[t],i.data=null,i.col[0].show=1===Math.abs(t),i.render()}var i,o,s,r=!1,d=new Box({title:"导入任务",html:"../../html/temp/import_task.html .import_task_ct",css:{width:"1000px"},fnSure:function(t){var e=$('[name="radio_task"]:checked').val(),n=$('[name="radio_channel"]:checked').val();return e?n?void a(e,n):($(".oper_tip_ct").operTip("请选择一个渠道！",{theme:"danger",dir:"bottom"}),!1):($(".oper_tip_ct").operTip("请选择一个任务！",{theme:"danger",dir:"bottom"}),!1)},fnCancel:function(t){console.dir(t)}}),l={"-2":"gray","-1":"warning",1:"info",2:"success"},c={$ct:$(".content"),theme:"warning",isLocal:!0,footerFix:!0,url:urls.task_list,sendData:{sort:"id",sort_dir:"desc",cur_page:1,task_status:-1,token:localStorage.getItem("token")},col:[{key:"id",title:'<label class="checkbox"><input type="checkbox" name="sel_task_all"><span class="opt_imitate"></span></label>',width:20,render:function(t,e){var a=$('<label class="checkbox"><input type="checkbox" value="'+e+'" name="sel_task"><span class="opt_imitate"></span></label>');t.append(a)}},{key:"id",title:"id",sort:!1,filter:!0},{key:"name",title:"名称",sort:!0,filter:!0,cls:"hidden_xs"},{key:"keyword",title:"关键词",sort:!1,filter:!0,cls:"hidden_md"},{key:"countall",title:"数量",sort:!1,filter:!0},{key:"id",title:"操作",width:120,render:function(t,e){var a=+$('[name="task_status"]:checked').val(),n='<button type="button" class="btn btn_info btn_query" data-id="'+e+'">查看</button>';-1===a&&(n+='<button type="button" class="btn btn_warning btn_modify" data-id="'+e+'">修改</button>'),n+='<button type="button" class="btn btn_primary btn_add" data-id="'+e+'">续单</button>',n+='<button type="button" class="btn btn_magenta btn_test" data-id="'+e+'">测试</button>',t.append($(n)).wrapInner("<div></div>")}}]};i=new Table(c),window.renderTable=function(){i.data=null,i.render()};var p=+localStorage.getItem("role");1!==p&&5!==p&&7!==p&&$(".btn_start,.btn_pause,.btn_stop,.import_task").remove(),$("body").on("click",".content>.table tbody tr",function(t){$(t.target).is('.btn,.opt_imitate,[type="checkbox"]')||$(this).find('[type="checkbox"]').trigger("click")}).on("click",".table_min tr",function(t){var e=$(this).find(".radio [type=radio]");e.is($(t.target))||e.trigger("click")}).on("click",'[name="task_status"]',function(){n(+$(this).val())}).on("click",".import_task",function(){e()}).on("click",".btn_start,.btn_pause,.btn_stop",function(){var e;$(this).is(".btn_start")?e=1:$(this).is(".btn_pause")?e=-1:$(this).is(".btn_stop")&&(e=-2);var a=$(this).data("id");a||(a=$('[name="sel_task"]:checked').map(function(t,e){return $(e).val()}).toArray().join()),t(e,a)}).on("click",".btn_query",function(){var t=$(this).data("id");window.open("../temp/detail_task.html?id="+t)}).on("click",".btn_modify",function(){var t=$(this).data("id"),e=$(this).parent();oper_task.box.initHeader("任务修改"),oper_task.box.operType="edit",oper_task.box.initContent("../../html/temp/add_task.html .add_task_form",function(){oper_task.box.show(),oper_task.afterDomReady(),render_task(t,function(t){1===t.status&&$("form.add_task").prepend($('<input type="hidden" name="task_id" value="'+t.data.id+'">'))})}),oper_task.box.afterfnSure=function(t,a){t?(e.operTip(a,{theme:"success"}),setTimeout(function(){renderTable()},1e3)):e.operTip(a,{theme:"danger"})}}).on("click",".btn_add",function(){var t=$(this).data("id"),e=$(this).parent();oper_task.box.initHeader("任务续单"),oper_task.box.operType="add",oper_task.box.initContent("../../html/temp/add_task.html .add_task_form",function(){oper_task.box.show(),oper_task.afterDomReady(),render_task(t),$(".data_count_ct").addClass("hidden").find(".data_count").prop("disabled",!0)}),oper_task.box.afterfnSure=function(t,a){t?(e.operTip(a,{theme:"success"}),setTimeout(function(){renderTable()},1e3)):e.operTip(a,{theme:"danger"})}}).on("click",".btn_test",function(){var t=$(this).data("id"),e=$(this).closest("td");$.ajax({url:urls.testUrl,type:"POST",dataType:"json",data:{taskid:t,token:token}}).done(function(t){1===t.status?e.operTip(JSON.stringify(t.data)||"排重测试通过.",{theme:"primary",timeout:0,alert:!0}):2===t.status?e.operTip(JSON.stringify(t.msg)||"排重测试未通过.",{theme:"danger",timeout:0,alert:!0}):e.find("div").operTip("操作失败!",{theme:"danger"})}).fail(function(t){e.find("div").operTip("操作失败!",{theme:"danger"})})})});